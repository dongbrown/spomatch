<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>네이버 지도</title>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script type="text/javascript" src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=1eruck1cfu"></script>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
        }

        #map {
            width: 100%;
            height: 100vh;
        }

        .cluster {
            cursor: pointer;
            text-align: center;
            font-size: 14px;
            font-weight: bold;
            color: white;
        }
        .cluster-1 {
            width: 40px;
            height: 40px;
            line-height: 40px;
            border-radius: 20px;
            background-color: rgba(33, 150, 243, 0.6);
        }
        .cluster-2 {
            width: 50px;
            height: 50px;
            line-height: 50px;
            border-radius: 25px;
            background-color: rgba(33, 150, 243, 0.7);
        }
        .cluster-3 {
            width: 60px;
            height: 60px;
            line-height: 60px;
            border-radius: 30px;
            background-color: rgba(33, 150, 243, 0.8);
        }
    </style>
</head>
<body>
<div id="map"></div>
<script>
    function truncateText(text, maxLength) {
        if (!text) return '정보없음';
        return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
    }

    function formatDate(dateStr) {
        if (!dateStr) return '정보없음';
        return `${dateStr.substring(0,4)}.${dateStr.substring(4,6)}.${dateStr.substring(6,8)}`;
    }

    function formatPrice(price) {
        if (!price) return '정보없음';
        return Number(price).toLocaleString() + '원';
    }

    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    // MarkerClustering 클래스 정의
    class MarkerClustering {
        constructor(options) {
            this.map = options.map;
            this.markers = [];
            this.clusters = [];
            this.minClusterSize = options.minClusterSize || 2;

            // 줌 레벨별 격자 크기 정의
            this.gridSizes = {
                7: 400,   // 낮은 줌에서는 더 큰 격자
                8: 300,
                9: 200,
                10: 150,
                11: 100,
                12: 80,
                13: 60,
                14: 0     // 14 이상에서는 클러스터링 하지 않음
            };

            this.setMarkers(options.markers);
        }

        setMarkers(markers) {
            this.clearClusters();
            this.markers = markers;
            this.redraw();
        }

        clearClusters() {
            this.clusters.forEach(cluster => {
                if (cluster.marker) {
                    cluster.marker.setMap(null);
                }
            });
            this.clusters = [];
            this.markers.forEach(marker => marker.setMap(null));
        }

        redraw() {
            const zoom = this.map.getZoom();
            this.clearClusters();

            // 높은 줌 레벨에서는 개별 마커 표시
            if (zoom >= 16) {
                this.markers.forEach(marker => marker.setMap(this.map));
                return;
            }

            const gridSize = this.gridSizes[zoom] || 100;
            const bounds = this.map.getBounds();
            const clustersMap = new Map();

            // 보이는 영역의 마커만 처리
            this.markers.filter(marker => bounds.hasLatLng(marker.getPosition())).forEach(marker => {
                const pos = marker.getPosition();
                const key = Math.floor(pos.lat() * gridSize) + "_" + Math.floor(pos.lng() * gridSize);

                if (!clustersMap.has(key)) {
                    clustersMap.set(key, {
                        position: pos,
                        markers: []
                    });
                }
                clustersMap.get(key).markers.push(marker);
            });

            // 클러스터 생성
            clustersMap.forEach(cluster => {
                if (cluster.markers.length >= this.minClusterSize) {
                    const clusterMarker = new naver.maps.Marker({
                        position: cluster.position,
                        map: this.map,
                        icon: {
                            content: this.createClusterIcon(cluster.markers.length),
                            size: new naver.maps.Size(40, 40),
                            anchor: new naver.maps.Point(20, 20)
                        }
                    });

                    // 클러스터 클릭 이벤트
                    naver.maps.Event.addListener(clusterMarker, 'click', () => {
                        this.map.setZoom(this.map.getZoom() + 2);
                        this.map.setCenter(clusterMarker.getPosition());
                    });

                    this.clusters.push({ marker: clusterMarker, markers: cluster.markers });
                } else {
                    cluster.markers.forEach(marker => marker.setMap(this.map));
                }
            });
        }

        createClusterIcon(count) {
            let className = 'cluster-1';
            if (count >= 10) className = 'cluster-2';
            if (count >= 30) className = 'cluster-3';
            return `<div class="cluster ${className}">${count}</div>`;
        }
    }

    var mapDiv = document.getElementById('map');
    var map = new naver.maps.Map(mapDiv, {
        zoom: 7,
        center: new naver.maps.LatLng(35.8, 127.5),
        maxZoom: 21,
        minZoom: 6,
        scaleControl: true,
        mapDataControl: false,
        zoomControl: true
    });

    var currentInfoWindow = null;
    var toggleStates = {};
    var markers = [];
    var clustering = null;

    function createInfoWindowContent(facility, showDetail, markerId) {
        return `
           <div style="padding:15px;min-width:280px;border-radius:6px;box-shadow:0 2px 6px rgba(0,0,0,0.1);font-family:'Noto Sans KR', sans-serif;">
               <h3 style="margin:0 0 15px 0;font-size:16px;color:#333;border-bottom:2px solid #2196F3;padding-bottom:8px;">
                   ${truncateText(facility.FCLTY_NM, 30)}
               </h3>

               <div style="background:#f8f9fa;padding:12px;border-radius:6px;margin-bottom:12px;">
                   <p style="margin:0;font-size:13px;color:#444;">
                       <strong style="color:#1976D2;">프로그램:</strong>
                       <span style="margin-left:4px;">${truncateText(facility.PROGRM_NM, 40)}</span>
                   </p>
               </div>

               <div style="margin-bottom:12px;">
                   <p style="margin:8px 0;font-size:13px;color:#555;display:flex;">
                       <span style="min-width:45px;color:#666;"><strong>지역</strong></span>
                       <span style="margin-left:8px;">${facility.CTPRVN_NM} ${facility.SIGNGU_NM}</span>
                   </p>
                   <p style="margin:8px 0;font-size:13px;color:#555;display:flex;">
                       <span style="min-width:45px;color:#666;"><strong>주소</strong></span>
                       <span style="margin-left:8px;">${facility.FCLTY_ADDR || '정보없음'}</span>
                   </p>
                   <p style="margin:8px 0;font-size:13px;color:#555;display:flex;">
                       <span style="min-width:45px;color:#666;"><strong>전화</strong></span>
                       <span style="margin-left:8px;">${facility.FCLTY_TEL_NO || '정보없음'}</span>
                   </p>
               </div>

               ${showDetail ? `
                   <div style="background:#fff;border:1px solid #e0e0e0;border-radius:6px;padding:12px;margin:15px 0;">
                       <h4 style="margin:0 0 10px 0;font-size:14px;color:#1976D2;">프로그램 정보</h4>
                       <p style="margin:5px 0;font-size:13px;"><strong>대상:</strong> ${facility.PROGRM_TRGET_NM || '정보없음'}</p>
                       <p style="margin:5px 0;font-size:13px;"><strong>요일:</strong> ${facility.PROGRM_ESTBL_WKDAY_NM || '정보없음'}</p>
                       <p style="margin:5px 0;font-size:13px;"><strong>시간:</strong> ${facility.PROGRM_ESTBL_TIZN_VALUE || '정보없음'}</p>
                       <p style="margin:5px 0;font-size:13px;"><strong>기간:</strong> ${formatDate(facility.PROGRM_BEGIN_DE)} ~ ${formatDate(facility.PROGRM_END_DE)}</p>
                       <p style="margin:5px 0;font-size:13px;"><strong>가격:</strong> <span style="color:#1976D2;font-weight:bold">${formatPrice(facility.PROGRM_PRC)}</span></p>
                       <p style="margin:5px 0;font-size:13px;"><strong>모집인원:</strong> ${facility.PROGRM_RCRIT_NMPR_CO || 0}명</p>
                   </div>
               ` : ''}

               <div style="display:flex;justify-content:space-between;align-items:center;margin-top:15px;padding-top:12px;border-top:1px solid #eee;">
                   <button onclick="window.toggleDetail_${markerId}()" style="padding:6px 12px;background:#2196F3;color:white;border:none;border-radius:4px;font-size:13px;cursor:pointer;">
                       ${showDetail ? '기본 정보만 보기' : '프로그램 상세정보'}
                   </button>
                   ${facility.HMPG_URL ? `
                       <a href="${facility.HMPG_URL}" target="_blank"
                          style="padding:6px 12px;background:#666;color:white;
                                 text-decoration:none;border-radius:4px;font-size:13px;margin-left:auto;">
                           홈페이지 방문
                       </a>
                   ` : ''}
               </div>
           </div>
       `;
    }
    const dataCache = new Map();  // 캐시 저장소

    const loadMarkers = debounce(function() {
        const bounds = map.getBounds();
        const zoom = map.getZoom();

        if (zoom <= 6) return; // 너무 낮은 줌에서는 로드하지 않음

        // 캐시 키 생성
        const cacheKey = `${bounds.toString()}_${zoom}`;

        // 캐시된 데이터가 있으면 사용
        if(dataCache.has(cacheKey)) {
            updateMarkersAndClusters(dataCache.get(cacheKey));
            return;
        }

        $.ajax({
            url: '/api/facilities',
            data: {
                minLat: bounds.getSW().lat(),
                maxLat: bounds.getNE().lat(),
                minLng: bounds.getSW().lng(),
                maxLng: bounds.getNE().lng(),
                zoom: zoom
            },
            success: function(facilities) {
                dataCache.set(cacheKey, facilities); // 캐시에 데이터 저장
                updateMarkersAndClusters(facilities);
            },
            error: function(xhr, status, error) {
                console.error("데이터 로딩 에러:", error);
            }
        });
    }, 500);

    function updateMarkersAndClusters(facilities) {
        // 기존 클러스터 정리
        if(clustering) {
            clustering.clearClusters();
        }

        // 마커 생성
        const newMarkers = facilities.map((facility, index) => {
            if(!facility.latitude || !facility.longitude) return null;

            const marker = new naver.maps.Marker({
                position: new naver.maps.LatLng(facility.latitude, facility.longitude)
            });

            // 클릭 이벤트 리스너 추가
            marker.addListener = function() {
                const markerId = `marker_${index}`;
                if (currentInfoWindow) {
                    currentInfoWindow.close();
                }

                const infoWindow = new naver.maps.InfoWindow({
                    content: createInfoWindowContent(facility, false, markerId),
                    borderWidth: 0,
                    backgroundColor: 'white',
                    anchorSize: new naver.maps.Size(12, 12),
                    anchorSkew: true,
                    pixelOffset: new naver.maps.Point(0, -5)
                });

                // 토글 함수 정의
                window[`toggleDetail_${markerId}`] = function() {
                    const isDetailView = !toggleStates[markerId];
                    toggleStates[markerId] = isDetailView;
                    infoWindow.setContent(createInfoWindowContent(facility, isDetailView, markerId));
                };

                infoWindow.open(map, marker);
                currentInfoWindow = infoWindow;
            };

            // 실제 클릭 이벤트는 마커 클릭 시에만 생성
            naver.maps.Event.addListener(marker, 'click', () => marker.addListener());

            return marker;
        }).filter(Boolean); // null 값 제거

        // 새로운 클러스터링 적용
        clustering = new MarkerClustering({
            map: map,
            markers: newMarkers,
            minClusterSize: 2,
            gridSize: getGridSizeByZoom(map.getZoom())
        });
    }

    // 줌 레벨별 그리드 사이즈 반환
    function getGridSizeByZoom(zoom) {
        const gridSizes = {
            7: 400,
            8: 300,
            9: 200,
            10: 150,
            11: 100,
            12: 80,
            13: 60,
            14: 40
        };
        return gridSizes[zoom] || 100;
    }

    // 이벤트 리스너 설정
    naver.maps.Event.once(map, 'init', loadMarkers);
    naver.maps.Event.addListener(map, 'dragend', loadMarkers);
    naver.maps.Event.addListener(map, 'zoom_changed', loadMarkers);
    naver.maps.Event.addListener(map, 'click', function() {
        if (currentInfoWindow) {
            currentInfoWindow.close();
            currentInfoWindow = null;
        }
    });
</script>
</body>
</html>