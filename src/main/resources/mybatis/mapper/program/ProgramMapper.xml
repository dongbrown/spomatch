<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.spomatch.dao.ProgramDAO">
    <!-- 프로그램 목록 조회 -->
    <select id="selectProgramList" parameterType="ProgramSearchRequestDTO" resultType="ProgramDTO">
        SELECT * FROM (
        SELECT ROWNUM AS rnum, A.* FROM (
        SELECT
        id,
        ctprvn_cd as cityCode,
        ctprvn_nm as cityName,
        signgu_cd as districtCode,
        signgu_nm as districtName,
        edc_goal_cn as educationGoalContent,
        fclty_addr as facilityAddress,
        fclty_nm as facilityName,
        fclty_tel_no as facilityPhoneNumber,
        fclty_ty_nm as facilityTypeName,
        hmpg_url as homepageUrl,
        ldr_qualfc_cn as leaderQualificationContent,
        progrm_begin_de as programBeginDate,
        progrm_end_de as programEndDate,
        progrm_nm as programName,
        progrm_estbl_wkday_nm as programOperationDays,
        progrm_estbl_tizn_value as programOperationTime,
        progrm_prc as programPrice,
        progrm_prc_ty_nm as programPriceTypeName,
        progrm_rcrit_nmpr_co as programRecruitNumber,
        progrm_trget_nm as programTargetName,
        progrm_ty_nm as programTypeName,
        prtc_nmpr_partcpt_at as protectorParticipationYn,
        safe_managt_cn as safetyManagementContent,
        view_count as viewCount,
        created_at as createdAt
        FROM FACILITY_PROGRAM
        WHERE 1=1
        <if test="cityName != null and cityName != ''">
            AND ctprvn_nm = #{cityName}
        </if>
        <if test="districtName != null and districtName != ''">
            AND signgu_nm = #{districtName}
        </if>
        <if test="programTargetName != null and programTargetName != ''">
            AND progrm_trget_nm = #{programTargetName}
        </if>
        <if test="events != null and events.size > 0">
            AND (
            <foreach item="event" collection="events" separator=" OR ">
                <choose>
                    <when test="event == '수영'">
                        progrm_nm LIKE '%수영%'
                    </when>
                    <when test="event == '골프'">
                        progrm_nm LIKE '%골프%'
                    </when>
                    <when test="event == '탁구'">
                        progrm_nm LIKE '%탁구%'
                    </when>
                    <when test="event == '배드민턴'">
                        progrm_nm LIKE '%배드민턴%'
                    </when>
                    <when test="event == '댄스'">
                        (progrm_nm LIKE '%댄스%' OR progrm_nm LIKE '%춤%')
                    </when>
                    <when test="event == '필라테스'">
                        progrm_nm LIKE '%필라테스%'
                    </when>
                    <when test="event == '헬스'">
                        (progrm_nm LIKE '%헬스%' OR progrm_nm LIKE '%피트니스%')
                    </when>
                    <when test="event == '테니스'">
                        progrm_nm LIKE '%테니스%'
                    </when>
                    <when test="event == '에어로빅'">
                        progrm_nm LIKE '%에어로빅%'
                    </when>
                    <when test="event == '축구'">
                        (program_nm LIKE '%축구%' OR program_nm LIKE '%풋살%')
                    </when>
                    <when test="event == '기타'">
                        progrm_nm NOT LIKE '%수영%'
                        AND progrm_nm NOT LIKE '%골프%'
                        AND progrm_nm NOT LIKE '%탁구%'
                        AND progrm_nm NOT LIKE '%배드민턴%'
                        AND progrm_nm NOT LIKE '%댄스%'
                        AND progrm_nm NOT LIKE '%춤%'
                        AND progrm_nm NOT LIKE '%필라테스%'
                        AND progrm_nm NOT LIKE '%헬스%'
                        AND progrm_nm NOT LIKE '%피트니스%'
                        AND progrm_nm NOT LIKE '%테니스%'
                        AND progrm_nm NOT LIKE '%에어로빅%'
                    </when>
                </choose>
            </foreach>
            )
        </if>
        <if test="weekdays != null and weekdays.size > 0">
            AND progrm_estbl_wkday_nm IN
            <foreach item="day" collection="weekdays" open="(" separator="," close=")">
                #{day}
            </foreach>
        </if>
        <if test="minPrice != null">
            AND progrm_prc <![CDATA[>=]]> #{minPrice}
        </if>
        <if test="maxPrice != null">
            AND progrm_prc <![CDATA[<=]]> #{maxPrice}
        </if>
        ORDER BY created_at DESC
        ) A WHERE ROWNUM <![CDATA[<=]]> #{end}
        ) WHERE rnum > #{start}
    </select>

    <!-- 프로그램 전체 개수 조회 -->
    <select id="selectProgramCount" parameterType="ProgramSearchRequestDTO" resultType="int">
        SELECT COUNT(*)
        FROM FACILITY_PROGRAM
        WHERE 1=1
        <if test="cityName != null and cityName != ''">
            AND ctprvn_nm = #{cityName}
        </if>
        <if test="districtName != null and districtName != ''">
            AND signgu_nm = #{districtName}
        </if>
        <if test="programTargetName != null and programTargetName != ''">
            AND progrm_trget_nm = #{programTargetName}
        </if>
        <if test="weekdays != null and weekdays.size > 0">
            AND progrm_estbl_wkday_nm IN
            <foreach item="day" collection="weekdays" open="(" separator="," close=")">
                #{day}
            </foreach>
        </if>
        <if test="minPrice != null">
            AND progrm_prc <![CDATA[>=]]> #{minPrice}
        </if>
        <if test="maxPrice != null">
            AND progrm_prc <![CDATA[<=]]> #{maxPrice}
        </if>
    </select>

    <!-- 프로그램 상세 조회 -->
    <select id="selectProgramDetail" parameterType="long" resultType="ProgramDTO">
        SELECT
            id,
            ctprvn_cd as cityCode,
            ctprvn_nm as cityName,
            signgu_cd as districtCode,
            signgu_nm as districtName,
            edc_goal_cn as educationGoalContent,
            fclty_addr as facilityAddress,
            fclty_nm as facilityName,
            fclty_tel_no as facilityPhoneNumber,
            fclty_ty_nm as facilityTypeName,
            hmpg_url as homepageUrl,
            ldr_qualfc_cn as leaderQualificationContent,
            progrm_begin_de as programBeginDate,
            progrm_end_de as programEndDate,
            progrm_nm as programName,
            progrm_estbl_wkday_nm as programOperationDays,
            progrm_estbl_tizn_value as programOperationTime,
            progrm_prc as programPrice,
            progrm_prc_ty_nm as programPriceTypeName,
            progrm_rcrit_nmpr_co as programRecruitNumber,
            progrm_trget_nm as programTargetName,
            progrm_ty_nm as programTypeName,
            prtc_nmpr_partcpt_at as protectorParticipationYn,
            safe_managt_cn as safetyManagementContent,
            view_count as viewCount,
            created_at as createdAt
        FROM FACILITY_PROGRAM
        WHERE id = #{programId}
    </select>

    <!-- 조회수 증가 -->
    <update id="updateViewCount" parameterType="long">
        UPDATE FACILITY_PROGRAM
        SET view_count = view_count + 1
        WHERE id = #{programId}
    </update>

    <!-- 찜하기 상태 확인 -->
    <select id="checkLikeStatus" parameterType="map" resultType="int">
        SELECT COUNT(*)
        FROM PROGRAM_LIKES
        WHERE program_id = #{programId}
          AND user_id = #{userId}
    </select>

    <!-- 찜하기 추가 -->
    <insert id="insertProgramLike" parameterType="map">
        INSERT INTO PROGRAM_LIKES (
            program_id,
            user_id,
            created_at
        ) VALUES (
                     #{programId},
                     #{userId},
                     SYSDATE
                 )
    </insert>

    <!-- 찜하기 삭제 -->
    <delete id="deleteProgramLike" parameterType="map">
        DELETE FROM PROGRAM_LIKES
        WHERE program_id = #{programId}
          AND user_id = #{userId}
    </delete>

    <!-- 찜하기 개수 조회 -->
    <select id="selectLikeCount" parameterType="long" resultType="long">
        SELECT COUNT(*)
        FROM PROGRAM_LIKES
        WHERE program_id = #{programId}
    </select>

    <!-- 신청 인원 조회 -->
    <select id="selectRegisterCount" parameterType="long" resultType="int">
        SELECT COUNT(*)
        FROM PROGRAM_REGISTERS
        WHERE program_id = #{programId}
    </select>

    <!-- 추천 프로그램 조회 -->
    <select id="selectRecommendedPrograms" parameterType="map" resultType="ProgramDTO">
        SELECT
            id,
            ctprvn_cd as cityCode,
            ctprvn_nm as cityName,
            signgu_cd as districtCode,
            signgu_nm as districtName,
            edc_goal_cn as educationGoalContent,
            fclty_addr as facilityAddress,
            fclty_nm as facilityName,
            fclty_tel_no as facilityPhoneNumber,
            fclty_ty_nm as facilityTypeName,
            hmpg_url as homepageUrl,
            ldr_qualfc_cn as leaderQualificationContent,
            progrm_begin_de as programBeginDate,
            progrm_end_de as programEndDate,
            progrm_nm as programName,
            progrm_estbl_wkday_nm as programOperationDays,
            progrm_estbl_tizn_value as programOperationTime,
            progrm_prc as programPrice,
            progrm_prc_ty_nm as programPriceTypeName,
            progrm_rcrit_nmpr_co as programRecruitNumber,
            progrm_trget_nm as programTargetName,
            progrm_ty_nm as programTypeName,
            prtc_nmpr_partcpt_at as protectorParticipationYn,
            safe_managt_cn as safetyManagementContent,
            view_count as viewCount,
            created_at as createdAt
        FROM FACILITY_PROGRAM p
        WHERE EXISTS (
            SELECT 1
            FROM PROGRAM_LIKES l
            WHERE l.user_id = #{userId}
              AND l.program_id = p.id
        )
          AND ROWNUM <![CDATA[<=]]> #{limit}
        ORDER BY created_at DESC
    </select>

    <!-- 시도 목록 조회 -->
    <select id="selectCityList" resultType="string">
        SELECT DISTINCT ctprvn_nm
        FROM FACILITY_PROGRAM
        ORDER BY ctprvn_nm
    </select>

    <!-- 시군구 목록 조회 -->
    <select id="selectDistrictList" resultType="string">
        SELECT DISTINCT signgu_nm
        FROM FACILITY_PROGRAM
        ORDER BY signgu_nm
    </select>

    <!-- 시설유형 목록 조회 -->
    <select id="selectFacilityTypeList" resultType="string">
        SELECT DISTINCT fclty_ty_nm
        FROM FACILITY_PROGRAM
        ORDER BY fclty_ty_nm
    </select>

    <!-- 프로그램유형 목록 조회 -->
    <select id="selectProgramTypeList" resultType="string">
        SELECT DISTINCT progrm_ty_nm
        FROM FACILITY_PROGRAM
        ORDER BY progrm_ty_nm
    </select>

    <!-- 대상연령 목록 조회 -->
    <select id="selectTargetAgeList" resultType="string">
        SELECT DISTINCT progrm_trget_nm
        FROM FACILITY_PROGRAM
        ORDER BY progrm_trget_nm
    </select>
</mapper>